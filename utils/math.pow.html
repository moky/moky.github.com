<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<title>幂运算</title>
		<meta name="keywords" content="qrcode" />
		<meta name="description" content="" />

		<meta name="viewport" content="width=device-width" />
		<!--[if lt IE 9]>
			<script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
		<![endif]-->
		
		<script type="text/javascript">
			
			function memory_key(x, y) {
				return x + '^' + y;
			}
			
			// output
			function clear_output() {
				var div = document.getElementById("output");
				div.innerHTML = "";
				var div = document.getElementById("result");
				div.innerHTML = "正在计算...";
			}
			function output(msg) {
				var div = document.getElementById("output");
				div.innerHTML = "<div>" + msg + "</div>" + div.innerHTML;
			}
			
			function middle_result(x, i, msg) {
				var msg = '<span>' + memory_key(x, i) + ' = </span>' + msg;
				output(msg);
			}
			function result(x, y, d) {
				var msg = '<span>' + memory_key(x, y) + ' = </span>' + d.stringValue();
				var div = document.getElementById("result");
				div.innerHTML = "<div>" + msg + "</div>";// + div.innerHTML;
			}
			
			// memory cache
			var pool = {};
			function push(x, y, d) {
				pool[memory_key(x, y)] = d.copy(); // save a copy of the big integer
				middle_result(x, y, d.stringValue());
			}
			function get(x, y) {
				var d = pool[memory_key(x, y)];
				if (d) {
					middle_result(x, y, '(cache)');
				}
				return d;
			}
			
			// calculating
			function step(x, y, i, fx) {
				if (i >= y) {
					result(x, i, fx);
					alert("Mission Accomplished!");
					return;
				}
				var t = y - i;
				if (t > i) {
					var tx = get(x, i + i);
					if (tx) {
						fx = tx; // cache value
					} else {
						fx = fx.multiply_assign(fx); // fx *= fx
						push(x, i + i, fx);
					}
					
					setTimeout(function() { step(x, y, i + i, fx); }, 1);
					return;
				}
				var dx = null;
				while (t > 0) {
					dx = get(x, t);
					if (dx) break;
					--t;
				}
				if (!dx) {
					alert("It's impossible!");
					return;
				}
				var tx = get(x, i + t);
				if (tx) {
					fx = tx; // cache value
				} else {
					fx = fx.multiply_assign(dx); // fx *= dx
					push(x, i + t, fx);
				}
				
				setTimeout(function() { step(x, y, i + t, fx); }, 1);
			}
			
			function pow(x, y) {
				clear_output();
				
				var fx = get(x, 1);
				if (!fx) {
					fx = tarsier.Integer.create(x); // big integer
					push(x, 1, fx);
				}
				setTimeout(function() { step(x, y, 1, fx); }, 1);
			}
			
			function int_value(v) {
				if (!v) return 0;
				v = v.toString();
				var i = v[0] == '-' || v[0] == '+' ? 1 : 0;
				for (; i < v.length; ++i) {
					if (v[i] < '0' || v[i] > '9') {
						break;
					}
				}
				return v.substring(0, i);
			}
			
			function calculate() {
				var _x = document.getElementById('x');
				var _y = document.getElementById('y');
				var x = _x.value;
				var y = _y.value;
				x = int_value(x);
				x = int_value(x);
				_x.value = x;
				_y.value = y;
				pow(x, y);
			}
			
			// main
			window.onload = function() {
				
				document.getElementById('submit').onclick = calculate;
				
				document.getElementById('loading').style.display = 'none';
				document.getElementById('tray').style.display = 'block';
				
				// copyright
				copyright("#copyright");
			}
		</script>
		
		<script type="text/javascript" src="../boot.js"></script>
		<script type="text/javascript" src="../js/share.js"></script>
		
		<link rel="stylesheet" type="text/css" href="../css/index.css" />
		<style type="text/css">
			div {
				word-wrap: break-word;
				word-break: break-all;
			}
			input {
				background-color: #999999;
				border: 1px solid #cccccc;
				text-align: center;
			}
			button {
				font-size: 18px;
			}
			#x {
				font-size: 24px;
				width: 150px;
				height: 32px
			}
			#y {
				font-size: 12px;
				width: 50px;
				height: 16px;
				vertical-align: top;
			}
			
			#tray {
				display: none;
			}
			#output {
				text-align: right;
				font-size: 12px;
				font-family: "Courier";
			}
			#output div {
				margin: 5px 10px;
				border-bottom: 1px dashed #333;
			}
			#result {
				margin: 20px;
				color: red;
			}
			
			#result span, #output span {
				color: green;
			}
		</style>
	</head>
	
	<body>
		<header>
			<h1 id="title">moky.github.com</h1>
		</header>
		
	<div id="wrap">
		
		<div id="loading">Loading...</div>
		
		<div id="tray">
			<div>
				求
				<input type="text" id="x" value="6" />
				的
				<input type="text" id="y" value="13" />
				次幂
				<button id="submit">结果是</button>
			</div>
			
			<div id="result"></div>
			<div id="output"></div>
		</div>
		
		<div class="clear">&nbsp;</div>
		
		<footer>
			<div id="copyright">&copy;2013 moKy</div>
		</footer>
		
	</div>
		
	</body>
</html>
